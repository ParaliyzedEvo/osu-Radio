name: Auto-Label Issues

on:
  issues:
    types: [opened, edited]

jobs:
  auto-label:
    runs-on: ubuntu-latest

    permissions:
      issues: write

    steps:
      - name: Auto-assign labels and comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body.toLowerCase();

            // Existing labels (duplicate protection)
            const existing = issue.labels.map(l => l.name.toLowerCase());

            const toAdd = new Set();

            // ---- TYPE LABELS ----
            if (body.includes("crash to desktop")) toAdd.add("bug");
            if (body.includes("app behaviour")) toAdd.add("bug");
            if (body.includes("performance")) toAdd.add("enhancement");
            if (body.includes("cosmetic")) toAdd.add("enhancement");
            if (body.includes("other")) toAdd.add("bug");

            // ---- APP vs UPDATER ----
            if (body.includes("updater")) toAdd.add("updater");

            // Safer detection for app (avoid matching "application" or normal text)
            if (body.match(/(?<=\bapp\b)/)) toAdd.add("app");

            // ---- OS LABELS ----
            if (body.includes("windows")) toAdd.add("windows");
            if (body.includes("macos")) toAdd.add("macOS");
            if (body.includes("linux")) toAdd.add("linux");

            // Filter duplicates
            const finalLabels = [...toAdd].filter(l => !existing.includes(l.toLowerCase()));

            // Add labels if needed
            if (finalLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: finalLabels
              });
            }

            // Add auto-comment on new issues
            if (context.payload.action === "opened") {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: "@ParaliyzedEvo will help you as soon as possible!"
              });
            }
